name: Lint and Code Quality

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  format:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5
      with:
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Check formatting
      run: |
        chmod +x scripts/format.sh
        ./scripts/format.sh --check

  lint:
    runs-on: ubuntu-latest
    needs: format

    steps:
    - uses: actions/checkout@v5
      with:
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"

    - name: Run flake8
      run: |
        python -m flake8 src/ tests/ --count --statistics

    - name: Check black formatting
      run: |
        python -m black --check --diff src/ tests/

    - name: Check isort import sorting
      run: |
        python -m isort --check-only --diff src/ tests/

    - name: Run pylint
      run: |
        # Run pylint and capture both output and score
        PYLINT_OUTPUT=$(python -m pylint src/ble_gatt_device/ --score y 2>&1)
        echo "$PYLINT_OUTPUT"

        # Extract score and check if it's exactly 10.00/10
        SCORE=$(echo "$PYLINT_OUTPUT" | grep -oP "rated at \K[0-9]+\.[0-9]+" | head -1)
        echo "Pylint score: $SCORE/10"

        # Fail if score is not exactly 10.00
        if [ "$SCORE" != "10.00" ]; then
          echo "❌ Pylint score must be exactly 10.00/10. Current score: $SCORE/10"
          echo "Please fix all pylint issues or add justified disable comments."
          exit 1
        fi

        echo "✅ Perfect pylint score achieved: 10.00/10"